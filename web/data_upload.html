<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Upload - Bug Report System</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .upload-container {
            max-width: 1000px;
            margin: 50px auto;
            padding: var(--spacing-2xl);
        }
        .upload-area {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(15px);
            border: 3px dashed rgba(209, 213, 219, 0.8);
            border-radius: var(--radius-xl);
            padding: var(--spacing-3xl);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: var(--spacing-xl);
        }
        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(255, 251, 240, 0.6);
        }
        .upload-area.dragover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #FFFBF0 0%, #FFF9E6 100%);
            transform: scale(1.02);
        }
        .file-info {
            background: var(--success-light);
            border: 2px solid #10B981;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            display: none;
        }
        .file-info.show {
            display: block;
        }
        .preview-table {
            overflow-x: auto;
            margin-top: var(--spacing-lg);
        }
        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .preview-table th {
            background: var(--gray-100);
            padding: var(--spacing-sm);
            border: 1px solid var(--gray-300);
            font-weight: 600;
        }
        .preview-table td {
            padding: var(--spacing-sm);
            border: 1px solid var(--gray-300);
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--gray-200);
            border-radius: 15px;
            overflow: hidden;
            margin: var(--spacing-lg) 0;
            display: none;
        }
        .progress-bar.show {
            display: block;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, #FF9500 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        /* Embedding Progress Modal */
        .embedding-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .embedding-modal.show {
            display: flex;
        }
        .embedding-modal-content {
            background: linear-gradient(135deg, #FFFFFF 0%, #F3F4F6 100%);
            border-radius: var(--radius-xl);
            padding: var(--spacing-3xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }
        .embedding-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-xl);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .embedding-progress-bar {
            width: 100%;
            height: 40px;
            background: #E5E7EB;
            border-radius: 20px;
            overflow: hidden;
            margin: var(--spacing-xl) 0;
        }
        .embedding-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FBBF24 0%, #F59E0B 50%, #D97706 100%);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #0A0E27 0%, #1a1f3a 100%); min-height: 100vh;">
    <div class="upload-container">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl);">
            <div>
                <h1 style="color: #ffffff; margin-bottom: var(--spacing-xs);">
                    Yeni Veri Seti y√ºkle
                </h1>
                <p style="color: #aaaaaa;">
                    CSV veya Excel dosyanƒ±zƒ± y√ºkleyin ve sisteme aktarn
                </p>
            </div>
            <button onclick="goBack()" class="btn btn-secondary">
                 Geri
            </button>
        </div>

        <!-- Info Box -->
        <div style="background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-left: 4px solid #0EA5E9; padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-xl);">
            <h3 style="margin: 0 0 var(--spacing-sm) 0; color: #0369A1;">
                 Desteklenen Formatlar
            </h3>
            <ul style="margin: 0; padding-left: 20px; color: #0C4A6E; font-size: 0.9rem;">
                <li>CSV dosyalarƒ± (.csv) - Virg√ºl veya noktalƒ± virg√ºl ayra√ß</li>
                <li>Excel dosyalarƒ± (.xlsx, .xls)</li>
                <li>UTF-8 encoding √∂nerilir (T√ºrk√ße karakter desteƒüi i√ßin)</li>
                <li>ƒ∞lk satƒ±r s√ºtun ba≈ülƒ±klarƒ± olmalƒ±</li>
                <li>En az 2 s√ºtun gerekli (summary ve description √∂nerilir)</li>
            </ul>
        </div>

        <!-- Upload Area -->
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 4rem; margin-bottom: var(--spacing-md);"></div>
            <h3 style="color: var(--secondary-color); margin-bottom: var(--spacing-sm);">
                Dosya Se√ßin veya S√ºr√ºkle-Bƒ±rak
            </h3>
            <p style="color: #aaaaaa; margin-bottom: var(--spacing-md);">
                CSV veya Excel dosyanƒ±zƒ± buraya s√ºr√ºkleyip bƒ±rakƒ±n
            </p>
            <button class="btn btn-primary" onclick="event.stopPropagation();">
                <span> Dosya Se√ß</span>
            </button>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
        </div>

        <!-- File Info -->
        <div id="fileInfo" class="file-info">
            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                <div style="font-size: 2rem;"></div>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 var(--spacing-xs) 0; color: #065F46;">Dosya Y√ºklendi</h4>
                    <p style="margin: 0; color: #047857; font-size: 0.9rem;">
                        <strong>Dosya:</strong> <span id="fileName"></span><br>
                        <strong>Boyut:</strong> <span id="fileSize"></span><br>
                        <strong>Satƒ±r:</strong> <span id="rowCount"></span><br>
                        <strong>S√ºtun:</strong> <span id="columnCount"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="progressBar" class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width: 0%;">0%</div>
        </div>

        <!-- Preview -->
        <div id="previewSection" style="display: none;">
            <h3 style="color: var(--secondary-color); margin-bottom: var(--spacing-md);">
                 Veri nizleme (lk 5 satr)
            </h3>
            <div class="preview-table" id="previewTable"></div>
        </div>

        <!-- Continue Button -->
        <button 
            id="continueBtn" 
            class="btn btn-primary" 
            style="width: 100%; margin-top: var(--spacing-xl); font-size: 1.1rem; padding: var(--spacing-lg);" 
            disabled
            onclick="continueToMapping()"
        >
            <span>S√ºtun E≈üle≈ütirmesine Ge√ß</span>
        </button>
    </div>

    <!-- Embedding Progress Modal -->
    <div id="embeddingModal" class="embedding-modal">
        <div class="embedding-modal-content">
            <div class="embedding-spinner"></div>
            <h2 style="color: var(--secondary-color); margin-bottom: var(--spacing-md);">
                ü§ñ Embedding Olu≈üturuluyor
            </h2>
            <p id="embeddingStatus" style="color: #6B7280; margin-bottom: var(--spacing-lg); font-size: 1rem;">
                Verileriniz i≈üleniyor...
            </p>
            <div class="embedding-progress-bar">
                <div id="embeddingProgressFill" class="embedding-progress-fill" style="width: 0%;">
                    0%
                </div>
            </div>
            <p style="color: #9CA3AF; font-size: 0.9rem; margin-top: var(--spacing-lg);">
                ‚ÑπÔ∏è Bu i≈ülem birka√ß dakika s√ºrebilir. L√ºtfen sayfayƒ± kapatmayƒ±n.
            </p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Check session
        const session = JSON.parse(localStorage.getItem('userSession'));
        if (!session) {
            window.location.href = 'login.html';
        }

        let uploadedData = null;
        let uploadedFileName = '';
        let uploadedFile = null;  // Store the actual File object for FormData upload

        // Drag and drop handlers
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        // File select handler
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // Handle file
        function handleFile(file) {
            uploadedFile = file;  // Store file for later FormData upload
            uploadedFileName = file.name;
            const fileSize = (file.size / 1024).toFixed(2) + ' KB';
            const fileExtension = file.name.split('.').pop().toLowerCase();

            console.log('File selected:', file.name, fileExtension);

            // Show progress
            document.getElementById('progressBar').classList.add('show');
            updateProgress(20, 'Dosya okunuyor...');

            if (fileExtension === 'csv') {
                parseCSV(file);
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                parseExcel(file);
            } else {
                alert(' Desteklenmeyen dosya format! l√ºtfen CSV veya Excel dosyas y√ºkleyin.');
                resetUpload();
            }
        }

        // Parse CSV
        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    updateProgress(60, 'Veri ileniyor...');
                    
                    if (results.data && results.data.length > 0) {
                        uploadedData = results.data;
                        displayFileInfo(results.data, results.meta.fields);
                        updateProgress(100, 'Tamamland!');
                        
                        setTimeout(() => {
                            document.getElementById('progressBar').classList.remove('show');
                        }, 1000);
                    } else {
                        alert(' Dosya bo veya hatal!');
                        resetUpload();
                    }
                },
                error: function(error) {
                    console.error('CSV parse error:', error);
                    alert(' CSV dosyasƒ± okunamadƒ±: ' + error.message);
                    resetUpload();
                }
            });
        }

        // Parse Excel
        function parseExcel(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    updateProgress(40, 'Excel dosyas okunuyor...');
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    updateProgress(60, 'Veri dntrlyor...');
                    
                    // Get first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData && jsonData.length > 0) {
                        uploadedData = jsonData;
                        const columns = Object.keys(jsonData[0]);
                        displayFileInfo(jsonData, columns);
                        updateProgress(100, 'Tamamland!');
                        
                        setTimeout(() => {
                            document.getElementById('progressBar').classList.remove('show');
                        }, 1000);
                    } else {
                        alert(' Excel dosyasƒ± bo≈ü!');
                        resetUpload();
                    }
                } catch (error) {
                    console.error('Excel parse error:', error);
                    alert(' Excel dosyasƒ± okunamadƒ±: ' + error.message);
                    resetUpload();
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Display file info
        function displayFileInfo(data, columns) {
            const fileSize = (JSON.stringify(data).length / 1024).toFixed(2) + ' KB';
            
            document.getElementById('fileName').textContent = uploadedFileName;
            document.getElementById('fileSize').textContent = fileSize;
            document.getElementById('rowCount').textContent = data.length.toLocaleString();
            document.getElementById('columnCount').textContent = columns.length;
            
            document.getElementById('fileInfo').classList.add('show');
            
            // Show preview
            displayPreview(data, columns);
            
            // Enable continue button
            document.getElementById('continueBtn').disabled = false;
        }

        // Display preview
        function displayPreview(data, columns) {
            const previewData = data.slice(0, 5);
            
            let html = '<table><thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const value = row[col] || '';
                    const truncated = value.toString().length > 50 
                        ? value.toString().substring(0, 50) + '...' 
                        : value;
                    html += `<td>${truncated}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            document.getElementById('previewTable').innerHTML = html;
            document.getElementById('previewSection').style.display = 'block';
        }

        // Update progress
        function updateProgress(percent, message) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = message || (percent + '%');
        }

        // Reset upload
        function resetUpload() {
            document.getElementById('progressBar').classList.remove('show');
            document.getElementById('fileInfo').classList.remove('show');
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('continueBtn').disabled = true;
            document.getElementById('fileInput').value = '';
            uploadedData = null;
        }

        // Show embedding progress modal
        function showEmbeddingModal() {
            document.getElementById('embeddingModal').classList.add('show');
        }
        
        // Hide embedding progress modal
        function hideEmbeddingModal() {
            document.getElementById('embeddingModal').classList.remove('show');
        }
        
        // Update embedding progress
        function updateEmbeddingProgress(percent, message) {
            const fill = document.getElementById('embeddingProgressFill');
            const statusText = document.getElementById('embeddingStatus');
            
            fill.style.width = percent + '%';
            fill.textContent = percent + '%';
            if (message) {
                statusText.textContent = message;
            }
        }
        
        // Continue to mapping
        async function continueToMapping() {
            if (!uploadedData) {
                alert('‚ö†Ô∏è L√ºtfen √∂nce bir dosya y√ºkleyin!');
                return;
            }
            
            // Disable button
            const btn = document.getElementById('continueBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥ Veri backend\'e g√∂nderiliyor...</span>';
            
            try {
                // Get user session for userId
                const session = JSON.parse(localStorage.getItem('userSession') || '{}');
                const userId = session.uid || session.username || 'anonymous';
                const username = session.username || 'demo';
                
                console.log('üì§ Uploading CSV file for user:', userId);
                console.log('üìÅ File name:', uploadedFileName);
                console.log('üìä Row count:', uploadedData.length);
                
                // Show embedding progress modal
                showEmbeddingModal();
                updateEmbeddingProgress(10, 'üì§ Veri backend\'e g√∂nderiliyor...');
                
                // Use FormData to send file directly (avoids JSON size limits)
                const formData = new FormData();
                
                // Use the stored file object
                if (uploadedFile) {
                    formData.append('file', uploadedFile);
                    formData.append('userId', userId);
                    formData.append('username', username);
                    formData.append('fileName', uploadedFileName);
                    formData.append('rowCount', uploadedData.length);
                    formData.append('columns', JSON.stringify(Object.keys(uploadedData[0])));
                    
                    console.log('üì§ FormData prepared:', {
                        fileName: uploadedFileName,
                        fileSize: uploadedFile.size,
                        rowCount: uploadedData.length,
                        userId: userId
                    });
                } else {
                    throw new Error('File not found. Please select a file again.');
                }
                
                // Send data to backend using FormData (no Content-Type header, let browser set it)
                const API_BASE_URL = 'https://esracevik01-jira-duplicate-detection.hf.space/api';
                const response = await fetch(`${API_BASE_URL}/upload_data`, {
                    method: 'POST',
                    body: formData  // FormData automatically sets multipart/form-data
                });
                
                updateEmbeddingProgress(30, 'üîÑ Veri i≈üleniyor...');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                updateEmbeddingProgress(50, 'ü§ñ Embedding modeli y√ºkleniyor...');
                
                const result = await response.json();
                
                updateEmbeddingProgress(70, '‚ú® Embeddings olu≈üturuluyor...');
                
                // Simulate embedding creation time for better UX
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateEmbeddingProgress(90, 'üíæ Veriler kaydediliyor...');
                
                if (result.success) {
                    console.log('‚úÖ Data uploaded to backend:', result.info);
                    
                    // Show embedding creation status
                    if (result.info && result.info.embeddingsCreated) {
                        console.log('‚úÖ Embeddings created successfully!');
                        console.log('üìÅ Embeddings path:', result.info.embeddingsPath);
                        updateEmbeddingProgress(100, '‚úÖ Embedding ba≈üarƒ±yla olu≈üturuldu!');
                    } else {
                        console.warn('‚ö†Ô∏è Embeddings creation failed or not completed');
                        updateEmbeddingProgress(100, '‚ö†Ô∏è Embedding olu≈üturma tamamlanamadƒ±');
                    }
                    
                    // Save as selectedDataset for column_mapping.html to use
                    localStorage.setItem('selectedDataset', JSON.stringify({
                        fileName: uploadedFileName,
                        rowCount: uploadedData.length,
                        columns: Object.keys(uploadedData[0]),
                        loadedAt: new Date().toISOString()
                    }));
                    
                    // Wait a bit before redirecting
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Redirect to column mapping
                    window.location.href = 'column_mapping.html';
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
                
            } catch (error) {
                console.error('Backend upload error:', error);
                hideEmbeddingModal();
                
                alert('‚ö†Ô∏è Veri backend\'e g√∂nderilemedi, ancak lokal olarak kaydedildi.\n\nHata: ' + error.message + '\n\nDevam edebilirsiniz.');
                
                // Save as selectedDataset even if backend fails
                localStorage.setItem('selectedDataset', JSON.stringify({
                    fileName: uploadedFileName,
                    rowCount: uploadedData.length,
                    columns: Object.keys(uploadedData[0]),
                    loadedAt: new Date().toISOString()
                }));
                
                // Still allow to continue even if backend upload fails
                window.location.href = 'column_mapping.html';
            } finally {
                // Re-enable button in case of error (but won't matter since we redirect)
                btn.disabled = false;
                btn.innerHTML = '<span>S√ºtun E≈üle≈ütirmesine Ge√ß</span>';
            }
        }

        // Go back
        function goBack() {
            if (uploadedData) {
                if (!confirm('Y√ºklenen veri kaybolacak. Geri d√∂nmek istediƒüinizden emin misiniz?')) {
                    return;
                }
            }
            window.location.href = 'data_selection.html';
        }
    </script>
    <script src="stars.js"></script>
</body>
</html>

